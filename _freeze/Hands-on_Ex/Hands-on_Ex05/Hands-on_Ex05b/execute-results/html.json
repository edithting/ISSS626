{
  "hash": "cee26dbf6eef07b3a45a3a2059b7adb8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-on Exercise 5b\"\nauthor: \"Yiwen Ding\"\n\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required libraries\nif (!requireNamespace(\"pacman\", quietly = TRUE)) install.packages(\"pacman\")\npacman::p_load(sf, spdep, tmap, tidyverse)\n\n# 1. Read the shapefile\nhunan <- st_read(dsn = \"data/geospatial\", layer = \"Hunan\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Hunan' from data source \n  `D:\\edithting\\ISSS626\\Hands-on_Ex\\Hands-on_Ex05\\data\\geospatial' \n  using driver `ESRI Shapefile'\nSimple feature collection with 88 features and 7 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 108.7831 ymin: 24.6342 xmax: 114.2544 ymax: 30.12812\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# (Alternatively, st_read(\"data/geospatial/Hunan.shp\") )\n\n# 2. Read the CSV file\nhunan2012 <- read_csv(\"data/aspatial/Hunan_2012.csv\")\n\n# 3. Join the CSV data to the spatial object\nhunan <- left_join(hunan, hunan2012, by = \"County\")\n\n# Optionally select or reorder columns\nhunan <- hunan %>%\n  select(1:4, 7, everything())\n\n# 4. Create contiguity-based spatial weights (Queen criterion)\nwm_q <- poly2nb(hunan, queen = TRUE)\nrswm_q <- nb2listw(wm_q, style = \"W\", zero.policy = TRUE)\n\n# 5. Compute local Moran’s I for a variable\nlocalMI <- localmoran(hunan$GDPPC, rswm_q)\n\ncolnames(localMI)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Ii\"             \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"          \n[5] \"Pr(z != E(Ii))\"\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(localMI)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            Ii          E.Ii       Var.Ii        Z.Ii Pr(z != E(Ii))\n1 -0.001468468 -2.815006e-05 4.723841e-04 -0.06626904      0.9471636\n2  0.025878173 -6.061953e-04 1.016664e-02  0.26266425      0.7928094\n3 -0.011987646 -5.366648e-03 1.133362e-01 -0.01966705      0.9843090\n4  0.001022468 -2.404783e-07 5.105969e-06  0.45259801      0.6508382\n5  0.014814881 -6.829362e-05 1.449949e-03  0.39085814      0.6959021\n6 -0.038793829 -3.860263e-04 6.475559e-03 -0.47728835      0.6331568\n```\n\n\n:::\n\n```{.r .cell-code}\n# 6. Attach the resulting local Moran’s I results back to the spatial object\npval_col <- grep(\"^Pr\", colnames(localMI), value = TRUE)\n\n# Rename p-value column safely\nnames(localMI)[names(localMI) == \"Pr(z != E(Ii))\"] <- \"Pr.Ii\"\n\n# Combine with spatial data\nhunan.localMI <- cbind(hunan, localMI)\n\n# Check column names\ncolnames(hunan.localMI)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"NAME_2\"         \"ID_3\"           \"NAME_3\"         \"ENGTYPE_3\"     \n [5] \"County\"         \"Shape_Leng\"     \"Shape_Area\"     \"City\"          \n [9] \"avg_wage\"       \"deposite\"       \"FAI\"            \"Gov_Rev\"       \n[13] \"Gov_Exp\"        \"GDP\"            \"GDPPC\"          \"GIO\"           \n[17] \"Loan\"           \"NIPCR\"          \"Bed\"            \"Emp\"           \n[21] \"EmpR\"           \"EmpRT\"          \"Pri_Stu\"        \"Sec_Stu\"       \n[25] \"Household\"      \"Household_R\"    \"NOIP\"           \"Pop_R\"         \n[29] \"RSCG\"           \"Pop_T\"          \"Agri\"           \"Service\"       \n[33] \"Disp_Inc\"       \"RORP\"           \"ROREmp\"         \"Ii\"            \n[37] \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"           \"Pr.z....E.Ii..\"\n[41] \"geometry\"      \n```\n\n\n:::\n\n```{.r .cell-code}\n# Should include \"Pr.Ii\"\n\n### --- Section 7: Local Moran’s I and significance map ---\n\n# Compute local Moran’s I\nlocalMI <- localmoran(hunan$GDPPC, rswm_q)\n\n# Attach results to hunan\nhunan.localMI <- cbind(hunan, localMI)\n\n# Rename the messy p-value column \"Pr(z != E(Ii))\" → \"Pr.Ii\"\nhunan.localMI <- hunan.localMI %>%\n  rename(Pr.Ii = Pr.z....E.Ii..)\n\n# Check result\ncolnames(hunan.localMI)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"NAME_2\"      \"ID_3\"        \"NAME_3\"      \"ENGTYPE_3\"   \"County\"     \n [6] \"Shape_Leng\"  \"Shape_Area\"  \"City\"        \"avg_wage\"    \"deposite\"   \n[11] \"FAI\"         \"Gov_Rev\"     \"Gov_Exp\"     \"GDP\"         \"GDPPC\"      \n[16] \"GIO\"         \"Loan\"        \"NIPCR\"       \"Bed\"         \"Emp\"        \n[21] \"EmpR\"        \"EmpRT\"       \"Pri_Stu\"     \"Sec_Stu\"     \"Household\"  \n[26] \"Household_R\" \"NOIP\"        \"Pop_R\"       \"RSCG\"        \"Pop_T\"      \n[31] \"Agri\"        \"Service\"     \"Disp_Inc\"    \"RORP\"        \"ROREmp\"     \n[36] \"Ii\"          \"E.Ii\"        \"Var.Ii\"      \"Z.Ii\"        \"Pr.Ii\"      \n[41] \"geometry\"   \n```\n\n\n:::\n\n```{.r .cell-code}\n# Map of Local Moran’s I\nmap_Ii <- tm_shape(hunan.localMI) +\n  tm_fill(col = \"Ii\",\n          style = \"pretty\",\n          palette = \"RdBu\",\n          title = \"Local Moran’s I\") +\n  tm_borders(alpha = 0.5)\n\n# Map of p-values\nmap_p <- tm_shape(hunan.localMI) +\n  tm_fill(col = \"Pr.Ii\",\n          breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),\n          palette = \"-Blues\",\n          title = \"p-value of Local Moran’s I\") +\n  tm_borders(alpha = 0.5)\n\ntmap_arrange(map_Ii, map_p, asp = 1, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\n### --- Section 8: LISA cluster map (High-High, Low-Low, etc.) ---\n\n# Compute spatial lag of GDPPC\nhunan$lag_GDPPC <- lag.listw(rswm_q, hunan$GDPPC)\n\n# Standardize GDPPC and lag\nz <- scale(hunan.localMI$GDPPC)[,1]\nlag_z <- scale(hunan$lag_GDPPC)[,1]\n\n# Significance level\nsignif_level <- 0.05\n\n# Identify significant areas\nhunan.localMI$quad_sig <- NA\nhunan.localMI$quad_sig[z >= 0 & lag_z >= 0 & hunan.localMI$Pr.Ii <= signif_level] <- \"High-High\"\nhunan.localMI$quad_sig[z <= 0 & lag_z <= 0 & hunan.localMI$Pr.Ii <= signif_level] <- \"Low-Low\"\nhunan.localMI$quad_sig[z >= 0 & lag_z <= 0 & hunan.localMI$Pr.Ii <= signif_level] <- \"High-Low\"\nhunan.localMI$quad_sig[z <= 0 & lag_z >= 0 & hunan.localMI$Pr.Ii <= signif_level] <- \"Low-High\"\nhunan.localMI$quad_sig[is.na(hunan.localMI$quad_sig)] <- \"Not Significant\"\n\n# Convert to factor for mapping\nhunan.localMI$quad_sig <- factor(hunan.localMI$quad_sig,\n                                 levels = c(\"High-High\", \"Low-Low\", \"High-Low\", \"Low-High\", \"Not Significant\"))\n\n# LISA cluster map\ntm_shape(hunan.localMI) +\n  tm_fill(\"quad_sig\",\n          palette = c(\"red\", \"blue\", \"orange\", \"lightblue\", \"grey80\"),\n          title = \"LISA Cluster Map\") +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](Hands-on_Ex05b_files/figure-html/unnamed-chunk-1-2.png){width=672}\n:::\n:::\n\n",
    "supporting": [
      "Hands-on_Ex05b_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}