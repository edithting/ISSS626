{
  "hash": "7ffb13e2f35c49941b8a56d3d54d7de3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Hands-on Exercise 4\"\nauthor: \"Yiwen Ding\"\n\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set CRAN mirror first\noptions(repos = c(CRAN = \"https://cran.r-project.org\"))\n\ninstall.packages(c(\"sf\", \"tmap\", \"tidyverse\", \"ggplot2\", \"ggspatial\", \n                  \"leaflet\", \"sp\", \"raster\", \"spdep\", \"htmlwidgets\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npackage 'sf' successfully unpacked and MD5 sums checked\npackage 'tmap' successfully unpacked and MD5 sums checked\npackage 'tidyverse' successfully unpacked and MD5 sums checked\npackage 'ggplot2' successfully unpacked and MD5 sums checked\npackage 'ggspatial' successfully unpacked and MD5 sums checked\npackage 'leaflet' successfully unpacked and MD5 sums checked\npackage 'sp' successfully unpacked and MD5 sums checked\npackage 'raster' successfully unpacked and MD5 sums checked\npackage 'spdep' successfully unpacked and MD5 sums checked\npackage 'htmlwidgets' successfully unpacked and MD5 sums checked\n\nThe downloaded binary packages are in\n\tC:\\Users\\Yiwen Ding\\AppData\\Local\\Temp\\RtmpAZ9IAz\\downloaded_packages\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(sf)\nlibrary(tmap)\nlibrary(tidyverse)\nlibrary(leaflet)\n\n# 1. LOADING AND EXPLORING DATA\n# Load shapefile from data/geospatial\nshp_file <- st_read(\"data/geospatial/Hunan.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Hunan' from data source \n  `D:\\edithting\\ISSS626\\Hands-on_Ex\\Hands-on_Ex04\\data\\geospatial\\Hunan.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 88 features and 7 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 108.7831 ymin: 24.6342 xmax: 114.2544 ymax: 30.12812\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load CSV file from data/aspatial\ncsv_data <- read.csv(\"data/aspatial/Hunan_2012.csv\")\n\n# 2. EXPLORE DATA STRUCTURE\ncat(\"=== SHAPEFILE INFORMATION ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n=== SHAPEFILE INFORMATION ===\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(shp_file)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 88 features and 7 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 108.7831 ymin: 24.6342 xmax: 114.2544 ymax: 30.12812\nGeodetic CRS:  WGS 84\nFirst 10 features:\n     NAME_2  ID_3    NAME_3   ENGTYPE_3 Shape_Leng Shape_Area    County\n1   Changde 21098   Anxiang      County   1.869074 0.10056190   Anxiang\n2   Changde 21100   Hanshou      County   2.360691 0.19978745   Hanshou\n3   Changde 21101    Jinshi County City   1.425620 0.05302413    Jinshi\n4   Changde 21102        Li      County   3.474325 0.18908121        Li\n5   Changde 21103     Linli      County   2.289506 0.11450357     Linli\n6   Changde 21104    Shimen      County   4.171918 0.37194707    Shimen\n7  Changsha 21109   Liuyang County City   4.060579 0.46016789   Liuyang\n8  Changsha 21110 Ningxiang      County   3.323754 0.26614198 Ningxiang\n9  Changsha 21111 Wangcheng      County   2.292093 0.13049161 Wangcheng\n10 Chenzhou 21112     Anren      County   2.240739 0.13343936     Anren\n                         geometry\n1  POLYGON ((112.0625 29.75523...\n2  POLYGON ((112.2288 29.11684...\n3  POLYGON ((111.8927 29.6013,...\n4  POLYGON ((111.3731 29.94649...\n5  POLYGON ((111.6324 29.76288...\n6  POLYGON ((110.8825 30.11675...\n7  POLYGON ((113.9905 28.5682,...\n8  POLYGON ((112.7181 28.38299...\n9  POLYGON ((112.7914 28.52688...\n10 POLYGON ((113.1757 26.82734...\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nShapefile column names:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nShapefile column names:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(names(shp_file))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"NAME_2\"     \"ID_3\"       \"NAME_3\"     \"ENGTYPE_3\"  \"Shape_Leng\"\n[6] \"Shape_Area\" \"County\"     \"geometry\"  \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nFirst few rows of shapefile:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFirst few rows of shapefile:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(head(shp_file))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 7 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 110.4922 ymin: 28.61762 xmax: 112.3013 ymax: 30.12812\nGeodetic CRS:  WGS 84\n   NAME_2  ID_3  NAME_3   ENGTYPE_3 Shape_Leng Shape_Area  County\n1 Changde 21098 Anxiang      County   1.869074 0.10056190 Anxiang\n2 Changde 21100 Hanshou      County   2.360691 0.19978745 Hanshou\n3 Changde 21101  Jinshi County City   1.425620 0.05302413  Jinshi\n4 Changde 21102      Li      County   3.474325 0.18908121      Li\n5 Changde 21103   Linli      County   2.289506 0.11450357   Linli\n6 Changde 21104  Shimen      County   4.171918 0.37194707  Shimen\n                        geometry\n1 POLYGON ((112.0625 29.75523...\n2 POLYGON ((112.2288 29.11684...\n3 POLYGON ((111.8927 29.6013,...\n4 POLYGON ((111.3731 29.94649...\n5 POLYGON ((111.6324 29.76288...\n6 POLYGON ((110.8825 30.11675...\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n=== CSV DATA INFORMATION ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== CSV DATA INFORMATION ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"CSV column names:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCSV column names:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(names(csv_data))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"County\"      \"City\"        \"avg_wage\"    \"deposite\"    \"FAI\"        \n [6] \"Gov_Rev\"     \"Gov_Exp\"     \"GDP\"         \"GDPPC\"       \"GIO\"        \n[11] \"Loan\"        \"NIPCR\"       \"Bed\"         \"Emp\"         \"EmpR\"       \n[16] \"EmpRT\"       \"Pri_Stu\"     \"Sec_Stu\"     \"Household\"   \"Household_R\"\n[21] \"NOIP\"        \"Pop_R\"       \"RSCG\"        \"Pop_T\"       \"Agri\"       \n[26] \"Service\"     \"Disp_Inc\"    \"RORP\"        \"ROREmp\"     \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nFirst few rows of CSV:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFirst few rows of CSV:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(head(csv_data))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     County       City avg_wage deposite    FAI Gov_Rev Gov_Exp     GDP GDPPC\n1     Anhua     Yiyang    30544  10967.0 6831.7  456.72  2703.0 13225.0 14567\n2     Anren   Chenzhou    28058   4598.9 6386.1  220.57  1454.7  4941.2 12761\n3   Anxiang    Changde    31935   5517.2 3541.0  243.64  1779.5 12482.0 23667\n4   Baojing Hunan West    30843   2250.0 1005.4  192.59  1379.1  4087.9 14563\n5   Chaling    Zhuzhou    31251   8241.4 6508.4  620.19  1947.0 11585.0 20078\n6 Changning   Hengyang    28518  10860.0 7920.0  769.86  2631.6 19886.0 24418\n      GIO   Loan  NIPCR  Bed    Emp  EmpR EmpRT Pri_Stu Sec_Stu Household\n1  9276.9 3954.9 3528.3 2718 494.31 441.4 338.0  54.175  32.830     290.4\n2  4189.2 2555.3 3271.8  970 290.82 255.4  99.4  33.171  17.505     104.6\n3  5108.9 2806.9 7693.7 1931 336.39 270.5 205.9  19.584  17.819     148.1\n4  3623.5 1253.7 4191.3  927 195.17 145.6 116.4  19.249  11.831      73.2\n5  9157.7 4287.4 3887.7 1449 330.29 299.0 154.0  33.906  20.548     148.7\n6 37392.0 4242.8 9528.0 3605 548.61 415.1 273.7  81.831  44.485     211.2\n  Household_R NOIP Pop_R    RSCG Pop_T     Agri Service Disp_Inc      RORP\n1       234.5  101 670.3 5760.60 910.8 4942.253  5414.5    12373 0.7359464\n2       121.9   34 243.2 2386.40 388.7 2357.764  3814.1    16072 0.6256753\n3       135.4   53 346.0 3957.90 528.3 4524.410 14100.0    16610 0.6549309\n4        69.9   18 184.1  768.04 281.3 1118.561   541.8    13455 0.6544614\n5       139.4  106 301.6 4009.50 578.4 3793.550  5444.0    20461 0.5214385\n6       211.7  115 448.2 5220.40 816.3 6430.782 13074.6    20868 0.5490628\n     ROREmp\n1 0.8929619\n2 0.8782065\n3 0.8041262\n4 0.7460163\n5 0.9052651\n6 0.7566395\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCSV structure:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCSV structure:\n```\n\n\n:::\n\n```{.r .cell-code}\nstr(csv_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t88 obs. of  29 variables:\n $ County     : chr  \"Anhua\" \"Anren\" \"Anxiang\" \"Baojing\" ...\n $ City       : chr  \"Yiyang\" \"Chenzhou\" \"Changde\" \"Hunan West\" ...\n $ avg_wage   : int  30544 28058 31935 30843 31251 28518 54540 28597 33580 33099 ...\n $ deposite   : num  10967 4599 5517 2250 8241 ...\n $ FAI        : num  6832 6386 3541 1005 6508 ...\n $ Gov_Rev    : num  457 221 244 193 620 ...\n $ Gov_Exp    : num  2703 1455 1780 1379 1947 ...\n $ GDP        : num  13225 4941 12482 4088 11585 ...\n $ GDPPC      : int  14567 12761 23667 14563 20078 24418 88656 10132 17026 18714 ...\n $ GIO        : num  9277 4189 5109 3624 9158 ...\n $ Loan       : num  3955 2555 2807 1254 4287 ...\n $ NIPCR      : num  3528 3272 7694 4191 3888 ...\n $ Bed        : int  2718 970 1931 927 1449 3605 3310 582 2170 2179 ...\n $ Emp        : num  494 291 336 195 330 ...\n $ EmpR       : num  441 255 270 146 299 ...\n $ EmpRT      : num  338 99.4 205.9 116.4 154 ...\n $ Pri_Stu    : num  54.2 33.2 19.6 19.2 33.9 ...\n $ Sec_Stu    : num  32.8 17.5 17.8 11.8 20.5 ...\n $ Household  : num  290.4 104.6 148.1 73.2 148.7 ...\n $ Household_R: num  234.5 121.9 135.4 69.9 139.4 ...\n $ NOIP       : int  101 34 53 18 106 115 214 17 55 70 ...\n $ Pop_R      : num  670 243 346 184 302 ...\n $ RSCG       : num  5761 2386 3958 768 4010 ...\n $ Pop_T      : num  911 389 528 281 578 ...\n $ Agri       : num  4942 2358 4524 1119 3794 ...\n $ Service    : num  5414 3814 14100 542 5444 ...\n $ Disp_Inc   : int  12373 16072 16610 13455 20461 20868 183252 12379 14595 15603 ...\n $ RORP       : num  0.736 0.626 0.655 0.654 0.521 ...\n $ ROREmp     : num  0.893 0.878 0.804 0.746 0.905 ...\n```\n\n\n:::\n\n```{.r .cell-code}\n# 3. IDENTIFY COMMON COLUMNS FOR JOINING\n# Find potential common columns\nshapefile_cols <- names(shp_file)\ncsv_cols <- names(csv_data)\n\n# Look for common column names\ncommon_cols <- intersect(shapefile_cols, csv_cols)\ncat(\"\\n=== POTENTIAL JOIN COLUMNS ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== POTENTIAL JOIN COLUMNS ===\n```\n\n\n:::\n\n```{.r .cell-code}\nif(length(common_cols) > 0) {\n  cat(\"Common columns found:\", paste(common_cols, collapse = \", \"), \"\\n\")\n} else {\n  cat(\"No common column names found. Looking for similar patterns...\\n\")\n  \n  # Check for columns that might contain similar data (like ID, code, etc.)\n  possible_id_cols_shp <- shapefile_cols[grepl(\"id|ID|code|Code|name|Name\", shapefile_cols)]\n  possible_id_cols_csv <- csv_cols[grepl(\"id|ID|code|Code|name|Name\", csv_cols)]\n  \n  cat(\"Possible ID columns in shapefile:\", paste(possible_id_cols_shp, collapse = \", \"), \"\\n\")\n  cat(\"Possible ID columns in CSV:\", paste(possible_id_cols_csv, collapse = \", \"), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCommon columns found: County \n```\n\n\n:::\n\n```{.r .cell-code}\n# 4. MANUAL COLUMN SELECTION FOR JOINING\n# Replace these with your actual column names based on the output above\nshapefile_join_col <- \"OBJECTID\"  # Change this to your shapefile's join column\ncsv_join_col <- \"ID\"              # Change this to your CSV's join column\n\n# Verify the columns exist\nif(shapefile_join_col %in% names(shp_file) && csv_join_col %in% names(csv_data)) {\n  cat(\"\\nJoining using:\", shapefile_join_col, \"(shapefile) and\", csv_join_col, \"(CSV)\\n\")\n  \n  # 5. DATA CLEANING\n  csv_data_clean <- csv_data %>%\n    mutate(across(where(is.character), as.factor)) %>%\n    drop_na(all_of(csv_join_col))  # Remove rows with missing join key\n  \n  # 6. JOIN THE DATA\n  spatial_joined <- shp_file %>%\n    left_join(csv_data_clean, by = setNames(csv_join_col, shapefile_join_col))\n  \n  cat(\"\\n=== AFTER JOINING ===\\n\")\n  cat(\"New data structure:\\n\")\n  print(spatial_joined)\n  cat(\"\\nNew column names:\\n\")\n  print(names(spatial_joined))\n  \n  # 7. BASIC MAPPING\n  # Find numeric columns for mapping\n  numeric_cols <- names(spatial_joined)[sapply(spatial_joined, is.numeric)]\n  cat(\"\\nNumeric columns available for mapping:\", paste(numeric_cols, collapse = \", \"), \"\\n\")\n  \n  if(length(numeric_cols) > 0) {\n    # Create a simple map using the first numeric column\n    map_variable <- numeric_cols[1]\n    \n    map1 <- tm_shape(spatial_joined) +\n      tm_polygons(map_variable,\n                  style = \"quantile\",\n                  palette = \"Blues\",\n                  title = map_variable) +\n      tm_layout(main.title = paste(\"Map of\", map_variable),\n                main.title.position = \"center\")\n    \n    print(map1)\n    \n    # 8. INTERACTIVE MAP\n    interactive_map <- leaflet() %>%\n      addTiles() %>%\n      addPolygons(data = spatial_joined,\n                  weight = 1,\n                  color = \"black\",\n                  fillColor = ~colorQuantile(\"YlOrRd\", spatial_joined[[map_variable]])(spatial_joined[[map_variable]]),\n                  fillOpacity = 0.7,\n                  popup = ~paste(\"Value:\", spatial_joined[[map_variable]]))\n    \n    print(interactive_map)\n  }\n  \n} else {\n  cat(\"\\n=== ERROR: JOIN COLUMNS NOT FOUND ===\\n\")\n  if(!shapefile_join_col %in% names(shp_file)) {\n    cat(\"Column\", shapefile_join_col, \"not found in shapefile.\\n\")\n  }\n  if(!csv_join_col %in% names(csv_data)) {\n    cat(\"Column\", csv_join_col, \"not found in CSV.\\n\")\n  }\n  cat(\"Available shapefile columns:\", paste(names(shp_file), collapse = \", \"), \"\\n\")\n  cat(\"Available CSV columns:\", paste(names(csv_data), collapse = \", \"), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== ERROR: JOIN COLUMNS NOT FOUND ===\nColumn OBJECTID not found in shapefile.\nColumn ID not found in CSV.\nAvailable shapefile columns: NAME_2, ID_3, NAME_3, ENGTYPE_3, Shape_Leng, Shape_Area, County, geometry \nAvailable CSV columns: County, City, avg_wage, deposite, FAI, Gov_Rev, Gov_Exp, GDP, GDPPC, GIO, Loan, NIPCR, Bed, Emp, EmpR, EmpRT, Pri_Stu, Sec_Stu, Household, Household_R, NOIP, Pop_R, RSCG, Pop_T, Agri, Service, Disp_Inc, RORP, ROREmp \n```\n\n\n:::\n\n```{.r .cell-code}\n# 9. ALTERNATIVE: IF NO COMMON COLUMNS, SHOW SEPARATE MAPS\nif(!exists(\"spatial_joined\")) {\n  cat(\"\\nCreating separate maps since join wasn't possible...\\n\")\n  \n  # Map of just the shapefile\n  tm_shape(shp_file) +\n    tm_polygons() +\n    tm_layout(title = \"Shapefile Geometry\")\n  \n  # If CSV has spatial coordinates, you could create a point map\n  if(any(grepl(\"lat|long|x|y\", names(csv_data), ignore.case = TRUE))) {\n    coords_cols <- names(csv_data)[grepl(\"lat|long|x|y\", names(csv_data), ignore.case = TRUE)]\n    cat(\"Potential coordinate columns in CSV:\", paste(coords_cols, collapse = \", \"), \"\\n\")\n  }\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCreating separate maps since join wasn't possible...\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPotential coordinate columns in CSV: County, City, Gov_Exp \n```\n\n\n:::\n\n```{.r .cell-code}\n# 10. CREATE OUTPUT DIRECTORY\nif(!dir.exists(\"output\")) {\n  dir.create(\"output\")\n}\n\n# Save the joined data if it exists\nif(exists(\"spatial_joined\")) {\n  st_write(spatial_joined, \"output/joined_data.shp\", delete_layer = TRUE)\n  cat(\"\\nJoined data saved to output/joined_data.shp\\n\")\n}\n\ncat(\"\\n=== ANALYSIS COMPLETED ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== ANALYSIS COMPLETED ===\n```\n\n\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}