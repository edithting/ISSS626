---
title: "Hands-on Exercise 2"
author: "Yiwen Ding"

execute: 
  eval: true
  echo: true
  warning: false
  freeze: true
---

```{r}
pacman::p_load(sf, terra, spatstat, tmap, rvest, tidyverse)
```

### Read Polygon Layer

```{r}
mpsz_sf <- st_read("data/MasterPlan2019SubzoneBoundaryNoSeaKML.kml") |>
  st_zm(drop = TRUE, what = "ZM") |>
  st_transform(crs = 3414)

extract_kml_field <- function(html_text, field_name) {
  if (is.na(html_text) || html_text == "") return(NA_character_)
  page <- rvest::read_html(html_text)
  rows <- page |> html_elements("tr")
  value <- rows |>
    keep(~ html_text2(html_element(.x, "th")) == field_name) |>
    html_element("td") |>
    html_text2()
  if (length(value) == 0) NA_character_ else value
}

mpsz_sf <- mpsz_sf |>
  mutate(
    REGION_N = map_chr(Description, extract_kml_field, "REGION_N"),
    PLN_AREA_N = map_chr(Description, extract_kml_field, "PLN_AREA_N"),
    SUBZONE_N = map_chr(Description, extract_kml_field, "SUBZONE_N"),
    SUBZONE_C = map_chr(Description, extract_kml_field, "SUBZONE_C")
  ) |>
  select(-Name, -Description) |>
  relocate(geometry, .after = last_col())

mpsz_cl <- mpsz_sf |>
  filter(SUBZONE_N != "SOUTHERN GROUP",
         PLN_AREA_N != "WESTERN ISLANDS",
         PLN_AREA_N != "NORTH-EASTERN ISLANDS")

```

### Read Point Layer

```{r}
childcare_sf <- st_read("data/ChildCareServices.kml") |>
  st_zm(drop = TRUE, what = "ZM") |>
  st_transform(crs = 3414)

tmap_mode("view")
tm_shape(childcare_sf) + tm_dots()
tmap_mode("plot")
```

### Convert to spatstat objects

```{r}
childcare_ppp <- spatstat.geom::as.ppp(childcare_sf)
sg_owin       <- spatstat.geom::as.owin(mpsz_cl)
childcareSG_ppp <- childcare_ppp[sg_owin]
```

### Clark-Evans Tests

```{r}
# Z-test
spatstat.explore::clarkevans.test(
  childcareSG_ppp,
  correction = "none",
  clipregion = "sg_owin",
  alternative = "clustered"
)

# Monte Carlo test
spatstat.explore::clarkevans.test(
  childcareSG_ppp,
  correction = "none",
  clipregion = "sg_owin",
  alternative = "clustered",
  method = "MonteCarlo",
  nsim = 99
)
```

### KDE

```{r}
library(spatstat.explore)
library(spatstat.model)
library(spatstat.geom)

bw <- bw.diggle(childcareSG_ppp)

kde_childcareSG <- density.ppp(childcareSG_ppp, sigma = bw)

plot(kde_childcareSG)

```

### Rasterize KDE and map

```{r}
kde_rast <- terra::rast(kde_childcareSG)
terra::crs(kde_rast) <- "EPSG:3414"

tmap_mode("plot")
tm_shape(kde_rast) +
  tm_raster(col.scale = tm_scale_continuous(values = "viridis"),
            col.legend = tm_legend(title = "Density (per km²)",
                                   title.size = 0.7, text.size = 0.7,
                                   bg.color = "white", bg.alpha = 0.7,
                                   position = tm_pos_in("right","bottom"),
                                   frame = TRUE)) +
  tm_graticules(labels.size = 0.7) +
  tm_compass() +
  tm_layout(scale = 1)
```

### By Planning Area

```{r}
library(spatstat.explore)
library(spatstat.model)
library(spatstat.geom)   # or install from GitHub
library(spatstat.explore)

# Filter by planning area
pg <- mpsz_cl |> filter(PLN_AREA_N == "PUNGGOL")
tm <- mpsz_cl |> filter(PLN_AREA_N == "TAMPINES")
ck <- mpsz_cl |> filter(PLN_AREA_N == "CHOA CHU KANG")
jw <- mpsz_cl |> filter(PLN_AREA_N == "JURONG WEST")

# Convert to ppp objects
pg_ppp <- childcare_ppp[as.owin(pg)]
tm_ppp <- childcare_ppp[as.owin(tm)]
ck_ppp <- childcare_ppp[as.owin(ck)]
jw_ppp <- childcare_ppp[as.owin(jw)]

# Rescale to km
pg_km <- rescale(pg_ppp, 1000, "km")
tm_km <- rescale(tm_ppp, 1000, "km")
ck_km <- rescale(ck_ppp, 1000, "km")
jw_km <- rescale(jw_ppp, 1000, "km")

# Clark–Evans test in Tampines
clarkevans.test(tm_ppp, correction="none", alternative="two.sided", nsim=999)

# KDE in Punggol
bw_pg <- bw.diggle(pg_km)
kde_pg <- density.ppp(pg_km, sigma = bw_pg, edge = TRUE, kernel = "gaussian")
plot(kde_pg, main = "Punggol KDE")

```

## Chapter 05

### Importing spatial data

```{r}
library(sf)
library(tmap)
library(spatstat)

library(dplyr)

# Childcare centres (point data)
childcare_sf <- st_read("data/ChildCareServices.kml")

# URA Master Plan 2019 Subzone Boundary (No Sea) (polygon data)
mpsz_sf <- st_read("data/MasterPlan2019SubzoneBoundaryNoSeaKML.kml")

summary(childcare_sf)
summary(mpsz_sf)
```

### Visualizing Data Layers

```{r}
```

```{r}
tmap_mode('view')
tm_shape(childcare_sf) + tm_dots()
tmap_mode('plot')

```

```         
```

### Handling Duplicate Points

```{r}
any(duplicated(childcare_ppp))
multiplicity(childcare_ppp)
sum(multiplicity(childcare_ppp) > 1)

childcare_ppp_jit <- rjitter(childcare_ppp, retry = TRUE, nsim = 1, drop = TRUE)
any(duplicated(childcare_ppp_jit))
```

### G-Function

#### Choa Chu Kang

```{r}
G_CK <- Gest(ck_km, correction = "border")
plot(G_CK)
G_CK.csr <- envelope(ck_km, Gest, nsim = 999)
plot(G_CK.csr)

```

#### Tampines

```{r}
G_tm <- Gest(tm_km, correction = "best")
plot(G_tm)
G_tm.csr <- envelope(tm_km, Gest, correction = "all", nsim = 999)
plot(G_tm.csr)
```

### F-Function

#### Choa Chu Kang

```{r}
F_CK <- Fest(ck_km)
plot(F_CK)
F_CK.csr <- envelope(ck_km, Fest, nsim = 999)
plot(F_CK.csr)

```

#### Tampines

```{r}
F_tm <- Fest(tm_km, correction = "best")
plot(F_tm)
F_tm.csr <- envelope(tm_km, Fest, correction = "all", nsim = 999)
plot(F_tm.csr)

```

### K-Function

#### Choa Chu Kang

```{r}
K_ck <- Kest(ck_km, correction = "Ripley")
plot(K_ck, . - r ~ r)
K_ck.csr <- envelope(ck_km, Kest, nsim = 99, rank = 1, glocal = TRUE)
plot(K_ck.csr, . - r ~ r)

```

#### Tampines

```{r}
K_tm <- Kest(tm_km, correction = "Ripley")
plot(K_tm, . - r ~ r, xlim = c(0,1000))
K_tm.csr <- envelope(tm_km, Kest, nsim = 99, rank = 1, glocal = TRUE)
plot(K_tm.csr, . - r ~ r, xlim = c(0,500))

```

### L-Function

#### Choa Chu Kang

```{r}
L_ck <- Lest(ck_km, correction = "Ripley")
plot(L_ck, . - r ~ r)
L_ck.csr <- envelope(ck_km, Lest, nsim = 99, rank = 1, glocal = TRUE)
plot(L_ck.csr, . - r ~ r)

```

#### Tampines

```{r}
L_tm <- Lest(tm_km, correction = "Ripley")
plot(L_tm, . - r ~ r, xlim = c(0,1000))
L_tm.csr <- envelope(tm_km, Lest, nsim = 99, rank = 1, glocal = TRUE)
plot(L_tm.csr, . - r ~ r, xlim = c(0,500))

```
