---
title: "Hands-on Exercise 3"
author: "Yiwen Ding"

execute: 
  eval: true
  echo: true
  warning: false
  freeze: true
---

```{r}
if(!requireNamespace("pacman", quietly=TRUE)) install.packages("pacman")
pacman::p_load(sf, terra, spatstat, sparr, tmap, tidyverse, lubridate)
```

### Read & Prepare Study Area

```{r}
library(rmapshaper)   # if not installed: install.packages("rmapshaper")

# Read and clean shapefile
kbb_sf <- st_read("data/KBB.shp") %>%
  st_make_valid() %>%
  st_transform(crs = 32748)

# Simplify geometry (retain topology)
kbb_sf <- rmapshaper::ms_simplify(kbb_sf, keep = 0.05) # keep 5% of vertices

# Convert to spatstat window -----------------------------

library(spatstat.geom)

# Safe conversion wrapper
safe_as_owin <- function(sf_obj) {
  tryCatch({
    as.owin(sf_obj)
  }, error = function(e) {
    message("Initial as.owin() failed, repairing geometry...")
    
    sf_obj <- sf_obj %>%
      st_make_valid() %>%
      st_buffer(0) %>%                     # fix self-touching polygons
      st_simplify(dTolerance = 50, preserveTopology = TRUE) %>%
      st_cast("MULTIPOLYGON")
    
    # Retry conversion
    as.owin(sf_obj)
  })
}

# Apply
kbb_owin <- safe_as_owin(kbb_sf)

```

### Import & Tidy Forest Fire Data

```{r}
# Read FF.csv (should contain: longitude, latitude, acq_date)
fire_sf <- readr::read_csv("data/FF.csv") %>%
  mutate(acq_date = lubridate::ymd(acq_date)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(crs = 32748) %>%
  mutate(
    DayofYear = lubridate::yday(acq_date),
    Month_num = lubridate::month(acq_date),
    Month_fac = lubridate::month(acq_date, label = TRUE, abbr = FALSE)
  )

# Preview data
head(fire_sf)

```

### Visualise Forest Fires

```{r}
# Overall point distribution
tm_shape(kbb_sf) + tm_polygons() +
  tm_shape(fire_sf) + tm_dots()

# Faceted map by month
tm_shape(kbb_sf) + tm_polygons() +
  tm_shape(fire_sf) + tm_dots(size = 0.1) +
  tm_facets(by = "Month_fac", free.coords = FALSE, drop.units = TRUE)


```

### Convert Fires to `ppp` by Month

```{r}
# Use Month_num as mark
fire_month <- fire_sf %>% select(Month_num)
fire_month_ppp <- as.ppp(fire_month)

# Clip to study region
fire_month_owin <- fire_month_ppp[kbb_owin]

# Check summary
summary(fire_month_owin)
plot(fire_month_owin, main = "Forest Fire Points with KBB Window")

```

### Spatio-Temporal KDE

```{r}
# KDE calculation
st_kde <- spattemp.density(fire_month_owin)

# View summary
summary(st_kde)

```

### Plot KDE (Jul - Dec)

```{r}
# Plot KDE for months 7â€“12
tims <- c(7,8,9,10,11,12)
par(mfcol = c(2,3))
for(i in tims){
  plot(st_kde, i, override.par = FALSE, fix.range = TRUE,
       main = paste("KDE at month", i))
}
```

### STKDE by Day of Year

```{r}
# Use DayofYear as mark
fire_yday <- fire_sf %>% select(DayofYear)
fire_yday_ppp <- as.ppp(fire_yday)

# Clip to study region
fire_yday_owin <- fire_yday_ppp[kbb_owin]

# KDE calculation
st_kde_yday <- spattemp.density(fire_yday_owin)

# View summary
summary(st_kde_yday)

# Plot for first 6 days (example)
par(mfcol = c(2,3))
for(i in 1:6){
  plot(st_kde_yday, i, override.par = FALSE, fix.range = TRUE,
       main = paste("KDE at day", i))
}

```
